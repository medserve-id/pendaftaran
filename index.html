<script>
    // URL Web App Google Apps Script Anda
    const APPS_SCRIPT_URL_FORM = 'https://script.google.com/macros/s/AKfycbwuUrDG495XvlcVK_-54ARj0aDti0KNawblulZtvAw_NgV4-7zGsdWhFbM_j5Xns_D2Pg/exec'; 

    const form = document.getElementById("form");
    const formContainer = document.getElementById("formContainer");
    const thankYou = document.getElementById("thankYou");

    // Menambahkan div untuk pesan respons (sukses/gagal)
    const responseMessageDiv = document.createElement('div');
    responseMessageDiv.id = 'responseMessage';
    responseMessageDiv.style.marginTop = '20px';
    responseMessageDiv.style.padding = '10px';
    responseMessageDiv.style.borderRadius = '8px';
    responseMessageDiv.style.fontWeight = 'bold';
    responseMessageDiv.style.textAlign = 'center';
    responseMessageDiv.style.display = 'none'; // Awalnya tersembunyi
    form.parentNode.insertBefore(responseMessageDiv, form.nextSibling); // Masukkan setelah form

    form.addEventListener("submit", async function(e) {
        e.preventDefault();

        // Tampilkan pesan loading
        responseMessageDiv.style.display = 'block';
        responseMessageDiv.style.backgroundColor = '#e0f2f7';
        responseMessageDiv.style.color = '#007bff';
        responseMessageDiv.textContent = 'Memproses pendaftaran Anda...';
        form.querySelector('button').disabled = true; // Nonaktifkan tombol saat memproses

        const nama = form.nama.value.trim();
        const paroki = form.paroki.value.trim();
        const kota = form.kota.value.trim();
        let whatsapp = form.whatsapp.value.trim(); // Gunakan let karena akan diformat

        // Validasi panjang karakter (dari kode Anda)
        if (nama.length > 25 || paroki.length > 18 || kota.length > 25) {
            responseMessageDiv.style.backgroundColor = '#ffe6e6';
            responseMessageDiv.style.color = '#dc3545';
            responseMessageDiv.textContent = "❌ Error: Cek kembali panjang karakter input Anda. Nama (max 25), Paroki (max 18), Kota (max 25).";
            form.querySelector('button').disabled = false;
            return;
        }

        // Validasi format nomor WhatsApp (dari kode Anda, tapi perhatikan format di backend)
        // Di backend, kita mengonversi 08 menjadi 628, jadi validasi ini cukup
        if (!/^0\d{9,11}$/.test(whatsapp)) {
            responseMessageDiv.style.backgroundColor = '#ffe6e6';
            responseMessageDiv.style.color = '#dc3545';
            responseMessageDiv.textContent = "❌ Error: Nomor WhatsApp harus dimulai dengan 0 dan terdiri dari 10-12 digit.";
            form.querySelector('button').disabled = false;
            return;
        }

        // Kumpulkan data ke objek JavaScript biasa
        const dataToSend = {
            action: 'registerNewPendaftar', // Ini sangat penting untuk Apps Script
            nama: nama,
            paroki: paroki,
            kota: kota,
            whatsapp: whatsapp
        };

        try {
            const response = await fetch(APPS_SCRIPT_URL_FORM, {
                method: "POST",
                mode: "cors", // Penting agar bisa membaca respons dari Apps Script
                headers: {
                    'Content-Type': 'application/json' // Memberitahu server bahwa kita mengirim JSON
                },
                body: JSON.stringify(dataToSend) // Mengirim data sebagai string JSON
            });

            // Pastikan respons dari Apps Script OK dan bisa diurai sebagai JSON
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json(); // Membaca respons JSON dari Apps Script

            if (result.success) {
                // Tampilkan pesan sukses dan sembunyikan formulir
                responseMessageDiv.style.backgroundColor = '#e6ffe6';
                responseMessageDiv.style.color = '#28a745';
                responseMessageDiv.textContent = `✅ ${result.message} No. Pendaftaran Anda: ${result.noPendaftaran}`;
                
                // Sembunyikan form dan tampilkan pesan terima kasih
                formContainer.style.display = "none";
                thankYou.style.display = "block";
                
                form.reset(); // Reset form setelah sukses
            } else {
                // Tampilkan pesan error dari server
                responseMessageDiv.style.backgroundColor = '#ffe6e6';
                responseMessageDiv.style.color = '#dc3545';
                responseMessageDiv.textContent = `❌ ${result.message}`;
                console.error("Server responded with error:", result.details || result.message);
            }

        } catch (error) {
            console.error('Error saat mendaftar:', error);
            responseMessageDiv.style.backgroundColor = '#ffe6e6';
            responseMessageDiv.style.color = '#dc3545';
            responseMessageDiv.textContent = `❌ Pendaftaran gagal: ${error.message}. Periksa koneksi internet atau coba lagi.`;
        } finally {
            form.querySelector('button').disabled = false; // Aktifkan kembali tombol
        }
    });
</script>
